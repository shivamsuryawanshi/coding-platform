# Deploy All Services to EC2
# Includes: Database migration, Judge, Backend, Frontend
# Triggered manually or on push to main

name: Deploy All Services

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'judge/**'
      - 'scripts/**'
      - 'questions/**'
      - '.github/workflows/deploy-all.yml'

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  DB_HOST: ${{ secrets.DB_HOST }}
  DB_NAME: ${{ secrets.DB_NAME }}
  DB_USER: ${{ secrets.DB_USER }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  S3_BUCKET: ${{ secrets.S3_BUCKET }}
  AWS_REGION: eu-north-1

jobs:
  # Step 1: Setup EC2, Database Schema, and Data Migration (RDS + S3)
  setup-and-migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup EC2 environment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              sudo apt-get update
              sudo apt-get install -y docker.io mysql-client python3-pip
              sudo systemctl enable docker
              sudo systemctl start docker
              sudo usermod -aG docker ubuntu
            fi
            
            # Install Python dependencies for migration
            pip3 install boto3 mysql-connector-python 2>/dev/null || true
            
            # Create app directory
            mkdir -p ~/codenexus
            echo "EC2 setup complete"

      - name: Copy migration scripts and questions to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "scripts/*,questions/*"
          target: "~/codenexus/"
          timeout: 600s

      - name: Run database schema and data migration
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 30m
          script: |
            echo "=========================================="
            echo "   DATABASE SCHEMA & DATA MIGRATION"
            echo "=========================================="
            
            cd ~/codenexus/scripts
            
            # Step 1: Apply database schema
            echo ""
            echo "üìã Step 1: Applying database schema..."
            mysql -h ${{ secrets.DB_HOST }} -P 3306 -u ${{ secrets.DB_USER }} -p'${{ secrets.DB_PASSWORD }}' ${{ secrets.DB_NAME }} < schema.sql || echo "Schema may already exist"
            echo "‚úÖ Database schema applied"
            
            # Step 2: Set environment variables for migration
            export DB_HOST=${{ secrets.DB_HOST }}
            export DB_USER=${{ secrets.DB_USER }}
            export DB_PASSWORD='${{ secrets.DB_PASSWORD }}'
            export DB_NAME=${{ secrets.DB_NAME }}
            export DB_PORT=3306
            export S3_BUCKET=${{ secrets.S3_BUCKET }}
            export AWS_REGION=eu-north-1
            
            # Step 3: Run data migration (RDS + S3)
            echo ""
            echo "üì¶ Step 2: Running data migration (RDS + S3)..."
            python3 migrate_questions.py
            
            # Step 4: Verify migration
            echo ""
            echo "=========================================="
            echo "   MIGRATION VERIFICATION"
            echo "=========================================="
            mysql -h ${{ secrets.DB_HOST }} -P 3306 -u ${{ secrets.DB_USER }} -p'${{ secrets.DB_PASSWORD }}' ${{ secrets.DB_NAME }} -e "
              SELECT 'Problems' as Type, COUNT(*) as Count FROM problems
              UNION ALL
              SELECT 'Testcases', COUNT(*) FROM testcases
              UNION ALL
              SELECT 'Tags', COUNT(*) FROM problem_tags;
            "
            echo ""
            echo "‚úÖ Migration complete!"

  # Step 2: Deploy Judge Service
  deploy-judge:
    runs-on: ubuntu-latest
    needs: setup-and-migrate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Judge Docker image
        run: |
          cd judge
          docker build -t codenexus-judge:latest .

      - name: Save Docker image
        run: |
          docker save codenexus-judge:latest -o judge-image.tar
          chmod 644 judge-image.tar

      - name: Copy image to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "judge-image.tar"
          target: "/tmp"

      - name: Deploy Judge to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            docker load -i /tmp/judge-image.tar
            docker stop judge 2>/dev/null || true
            docker rm judge 2>/dev/null || true
            docker run -d \
              --name judge \
              --restart unless-stopped \
              --memory=1g \
              -p 5000:5000 \
              codenexus-judge:latest
            rm /tmp/judge-image.tar
            echo "Judge deployed on port 5000"

  # Step 3: Deploy Backend Service
  deploy-backend:
    runs-on: ubuntu-latest
    needs: deploy-judge
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: |
          cd backend
          mvn clean package -DskipTests -B

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Backend Docker image
        run: |
          cd backend
          docker build -t codenexus-backend:latest .

      - name: Save Docker image
        run: |
          docker save codenexus-backend:latest -o backend-image.tar
          chmod 644 backend-image.tar

      - name: Copy image to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "backend-image.tar"
          target: "/tmp"

      - name: Deploy Backend to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            docker load -i /tmp/backend-image.tar
            docker stop backend 2>/dev/null || true
            docker rm backend 2>/dev/null || true
            docker run -d \
              --name backend \
              --restart unless-stopped \
              --memory=512m \
              -p 8080:8080 \
              -e DB_HOST=${{ secrets.DB_HOST }} \
              -e DB_PORT=3306 \
              -e DB_NAME=${{ secrets.DB_NAME }} \
              -e DB_USER=${{ secrets.DB_USER }} \
              -e DB_PASSWORD='${{ secrets.DB_PASSWORD }}' \
              -e AWS_REGION=eu-north-1 \
              -e S3_BUCKET=${{ secrets.S3_BUCKET }} \
              -e JUDGE_HOST=172.17.0.1 \
              -e JUDGE_PORT=5000 \
              codenexus-backend:latest
            rm /tmp/backend-image.tar
            echo "Backend deployed on port 8080"

  # Step 4: Deploy Frontend Service
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies and build
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Frontend Docker image
        run: |
          cd frontend
          docker build -t codenexus-frontend:latest .

      - name: Save Docker image
        run: |
          docker save codenexus-frontend:latest -o frontend-image.tar
          chmod 644 frontend-image.tar

      - name: Copy image to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "frontend-image.tar"
          target: "/tmp"

      - name: Deploy Frontend to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            docker load -i /tmp/frontend-image.tar
            docker stop frontend 2>/dev/null || true
            docker rm frontend 2>/dev/null || true
            
            # Get backend container IP
            BACKEND_IP=$(docker inspect backend --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' 2>/dev/null || echo "172.17.0.1")
            
            # Create/connect to Docker network if needed
            docker network create codenexus-net 2>/dev/null || true
            docker network connect codenexus-net backend 2>/dev/null || true
            
            # Start frontend with backend IP mapping
            docker run -d \
              --name frontend \
              --restart unless-stopped \
              --memory=256m \
              --network codenexus-net \
              --add-host=backend:${BACKEND_IP} \
              -p 80:80 \
              codenexus-frontend:latest
            rm /tmp/frontend-image.tar
            docker image prune -f
            echo "Frontend deployed on port 80 with backend connection"

  # Step 5: Verify deployment (EC2 + RDS + S3)
  verify:
    runs-on: ubuntu-latest
    needs: deploy-frontend
    steps:
      - name: Verify all services and data
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=========================================="
            echo "       COMPLETE DEPLOYMENT VERIFICATION"
            echo "=========================================="
            echo ""
            
            # 1. Docker Containers Status
            echo "üì¶ Docker Containers:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo ""
            
            # 2. Health Checks
            echo "üè• Service Health Checks:"
            echo -n "  Judge:    "
            curl -s http://localhost:5000/health | grep -o '"status":"[^"]*"' || echo "FAILED"
            echo -n "  Backend:  "
            curl -s http://localhost:8080/api/health | grep -o '"status":"[^"]*"' || echo "FAILED"
            echo -n "  Frontend: "
            curl -s -o /dev/null -w '%{http_code}' http://localhost:80 && echo " OK" || echo " FAILED"
            echo ""
            
            # 3. Database Verification
            echo "üíæ Database (RDS) Status:"
            mysql -h ${{ secrets.DB_HOST }} -P 3306 -u ${{ secrets.DB_USER }} -p'${{ secrets.DB_PASSWORD }}' ${{ secrets.DB_NAME }} -e "
              SELECT 'Problems' as Type, COUNT(*) as Count FROM problems
              UNION ALL
              SELECT 'Testcases', COUNT(*) FROM testcases
              UNION ALL
              SELECT 'Tags', COUNT(*) FROM problem_tags;
            " 2>/dev/null || echo "  Database check failed"
            echo ""
            
            # 4. S3 Verification (using Python)
            echo "‚òÅÔ∏è  S3 Bucket Status:"
            python3 << 'EOF'
            import boto3
            import os
            try:
                s3 = boto3.client('s3', region_name='eu-north-1')
                bucket = os.getenv('S3_BUCKET', '${{ secrets.S3_BUCKET }}')
                response = s3.list_objects_v2(Bucket=bucket, Prefix='problems/', MaxKeys=5)
                if 'Contents' in response:
                    print(f"  ‚úÖ S3 bucket accessible: {bucket}")
                    print(f"  ‚úÖ Found {len(response['Contents'])} testcase files (showing first 5)")
                    for obj in response['Contents'][:5]:
                        print(f"     - {obj['Key']}")
                else:
                    print(f"  ‚ö†Ô∏è  S3 bucket empty or no testcases found")
            except Exception as e:
                print(f"  ‚ùå S3 check failed: {e}")
            EOF
            echo ""
            
            # 5. Final Summary
            echo "=========================================="
            echo "  üéâ COMPLETE DEPLOYMENT SUCCESSFUL!"
            echo "=========================================="
            echo ""
            echo "üåê Access URLs:"
            echo "  Frontend: http://${{ secrets.EC2_HOST }}"
            echo "  Backend:  http://${{ secrets.EC2_HOST }}:8080/api"
            echo "  Judge:    http://${{ secrets.EC2_HOST }}:5000/health"
            echo ""
            echo "üìä Infrastructure:"
            echo "  ‚úÖ EC2: Services running"
            echo "  ‚úÖ RDS: Database connected"
            echo "  ‚úÖ S3:  Testcases uploaded"
            echo ""
            echo "=========================================="
