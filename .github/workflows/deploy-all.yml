# Deploy All Services
# Manual trigger to deploy all services at once
# Use this for initial setup or full redeployment

name: Deploy All Services

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  deploy-judges:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        judge:
          - { name: judge-python, port: 5000, dir: judge-python }
          - { name: judge-cpp, port: 5002, dir: judge-cpp }
          - { name: judge-java, port: 5003, dir: judge-java }
          - { name: judge-js, port: 5004, dir: judge-js }
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          cd ${{ matrix.judge.dir }}
          docker build -t ${{ matrix.judge.name }}:latest .

      - name: Save Docker image
        run: |
          docker save ${{ matrix.judge.name }}:latest -o ${{ matrix.judge.name }}-image.tar

      - name: Copy image to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "${{ matrix.judge.name }}-image.tar"
          target: "/tmp"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            docker load -i /tmp/${{ matrix.judge.name }}-image.tar
            docker stop ${{ matrix.judge.name }} 2>/dev/null || true
            docker rm ${{ matrix.judge.name }} 2>/dev/null || true
            docker run -d \
              --name ${{ matrix.judge.name }} \
              --restart unless-stopped \
              --memory=512m \
              --cpus=0.5 \
              -p ${{ matrix.judge.port }}:${{ matrix.judge.port }} \
              ${{ matrix.judge.name }}:latest
            rm /tmp/${{ matrix.judge.name }}-image.tar
            echo "${{ matrix.judge.name }} deployed on port ${{ matrix.judge.port }}"

  deploy-backend:
    runs-on: ubuntu-latest
    needs: deploy-judges
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: |
          cd backend
          mvn clean package -DskipTests -B

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          cd backend
          docker build -t coding-platform-backend:latest .

      - name: Save Docker image
        run: |
          docker save coding-platform-backend:latest -o backend-image.tar

      - name: Copy image to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "backend-image.tar"
          target: "/tmp"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            docker load -i /tmp/backend-image.tar
            docker stop backend 2>/dev/null || true
            docker rm backend 2>/dev/null || true
            docker run -d \
              --name backend \
              --restart unless-stopped \
              --memory=512m \
              --cpus=0.5 \
              -p 8080:8080 \
              --add-host=host.docker.internal:host-gateway \
              -e JUDGE_HOST=host.docker.internal \
              coding-platform-backend:latest
            rm /tmp/backend-image.tar
            echo "Backend deployed on port 8080"

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-backend
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          cd frontend
          docker build -t coding-platform-frontend:latest .

      - name: Save Docker image
        run: |
          docker save coding-platform-frontend:latest -o frontend-image.tar

      - name: Copy image to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "frontend-image.tar"
          target: "/tmp"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            docker load -i /tmp/frontend-image.tar
            docker stop frontend 2>/dev/null || true
            docker rm frontend 2>/dev/null || true
            docker run -d \
              --name frontend \
              --restart unless-stopped \
              --memory=256m \
              --cpus=0.5 \
              -p 80:80 \
              --add-host=backend:host-gateway \
              coding-platform-frontend:latest
            rm /tmp/frontend-image.tar
            docker image prune -f
            echo "Frontend deployed on port 80"

  verify-deployment:
    runs-on: ubuntu-latest
    needs: deploy-frontend
    
    steps:
      - name: Verify all services
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=== All Running Containers ==="
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo ""
            echo "=== Health Checks ==="
            echo "Python Judge:" && curl -s http://localhost:5000/health | head -1
            echo "C++ Judge:" && curl -s http://localhost:5002/health | head -1
            echo "Java Judge:" && curl -s http://localhost:5003/health | head -1
            echo "JS Judge:" && curl -s http://localhost:5004/health | head -1
            echo "Backend:" && curl -s http://localhost:8080/health | head -1
            echo "Frontend:" && curl -s -o /dev/null -w "%{http_code}" http://localhost:80
            
            echo ""
            echo "=== Deployment Complete! ==="
            echo "Frontend: http://${{ secrets.EC2_HOST }}"
            echo "Backend API: http://${{ secrets.EC2_HOST }}:8080"

